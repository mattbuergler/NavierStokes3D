using Test
using Test
include("../scripts/PorousConvection_3D_xpu.jl")

# Unit tests for averaging functions
@testset "Test average functions" begin
    @test all(av1([1, 2, 3, 4]) .≈ [1.5, 2.5, 3.5])
    @test all(avx([1 2 3 4;  1 2 3 4]) .≈ [1 2 3 4])
    @test all(avy([1 2 3 4;  1 2 3 4]) .≈ [1.5 2.5 3.5; 1.5 2.5 3.5])
end

# Reference tests
# get the solution
T = run_navierstokes3D(do_vis=true, do_save=true, do_print=false, nx=255, nt=1000)
# reference indices and solutions
inds_x = [31 38 50 51]
inds_y = [2 5 19 31]
inds_z = [12 13 23 23]
T_ref = [1.533238393934448e-7 1.528864051208823e-7 1.5339073726141464e-7 1.5343984486166758e-7;;;;
         4.899815577977306e-7 1.5616085552454124e-7 1.5338275094223396e-7 1.534319424539255e-7;;;;
         0.19578294327792722 0.001261159687564842 1.5335773442293184e-7 1.534034099299091e-7;;;;
         1.533238393934448e-7 1.528864051208823e-7 1.5339073726141467e-7 1.5343984486166758e-7;;;;;;
         1.519773048824846e-8 1.3958550021722135e-8 1.4004152193940194e-8 1.4009325656876154e-8;;;;
         9.978308687706312e-7 2.2305446976064653e-8 1.4003073776407945e-8 1.400832708667883e-8;;;;
         0.6208831467566082 0.004033942968227375 1.3999179729038258e-8 1.4004434106377066e-8;;;;
         1.519773048824846e-8 1.3958550021722135e-8 1.4004152193940194e-8 1.4009325656876154e-8;;;;;;
        -0.00016058350179262487 -0.00015965105843374818 -0.00015358800129985288 -0.00015316531554535897;;;;
        -0.00015840028184221653 -0.00015895701351855638 -0.00015374902285328045 -0.00015330228647029593;;;;
         0.3830266309792465 0.0003346988596948679 -0.0001544133298812684 -0.00015388114137263316;;;;
        -0.0001605835017926249 -0.00015965105843374823 -0.0001535880012998529 -0.00015316531554535897;;;;;;
        -0.00016058350179262487 -0.00015965105843374818 -0.00015358800129985288 -0.00015316531554535897;;;;
        -0.00015840028184221653 -0.00015895701351855638 -0.00015374902285328045 -0.00015330228647029593;;;;
         0.3830266309792465 0.0003346988596948679 -0.0001544133298812684 -0.00015388114137263316;;;;
        -0.0001605835017926249 -0.00015965105843374823 -0.0001535880012998529 -0.00015316531554535897]

# run reference tests
@testset "Test porous_convection_3D" begin
    @test all(T[inds_x,inds_y,inds_z] .≈ T_ref)
end